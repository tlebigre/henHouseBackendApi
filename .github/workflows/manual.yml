name: Deploy HenHouse API (Micronaut)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - staging

jobs:
  deploy:
    runs-on: [self-hosted, henhouse-api]

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # Java (Micronaut)
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          
      # Build Micronaut JAR
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: Change wrapper permissions
        run: chmod +x ./gradlew
      - name: Build with Gradle
        run: ./gradlew build

      # Copy JAR to Raspberry Pi
      - name: Deploy JAR to /opt/henhouse/api
        run: |
          sudo mkdir -p /opt/henhouse/api
          sudo cp build/libs/*-all.jar /opt/henhouse/api/app.jar

      # Inject API_IP into systemd env
      - name: Configure API_IP environment variable
        run: |
          echo "API_IP=${{ secrets.API_IP }}" | sudo tee /etc/henhouse-api.env
          sudo chmod 600 /etc/henhouse-api.env

      # Restart systemd service
      - name: Restart HenHouse API service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl restart henhouse-api
          sudo systemctl status henhouse-api --no-pager
