name: Deploy HenHouse API (Micronaut)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - staging

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Java (Micronaut)
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          
      # 3️⃣ Build Micronaut JAR
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: Change wrapper permissions
        run: chmod +x ./gradlew
      - name: Build with Gradle
        run: ./gradlew build

      # 4️⃣ Copy JAR to Raspberry Pi
      - name: Deploy JAR to /opt/henhouse/api
        run: |
          sudo mkdir -p /opt/henhouse/api
          sudo cp build/libs/*-all.jar /opt/henhouse/api/app.jar

      # 5️⃣ Restart systemd service
      - name: Restart HenHouse API service
        run: |
          sudo systemctl daemon-reload
          sudo systemctl restart henhouse-api
          sudo systemctl status henhouse-api --no-pager
